#!/bin/bash

# get the preset from the wrapper scripts
type=$1
IFS='|'
read -ra opts <<< "$2"
IFS=' '
file="$3"

shift 3

REGIONS=("${@:-ES}")

if [[ "${1,,}" == "ccaa" ]]; then
  REGIONS=(AN AS AR CN CB CL CM CT M VC PV EX GA IB RI NA MU)
elif [[ "${1,,}" == "prov" ]]; then
  REGIONS=(C A AB AL VI AV BA B BI BU CC CA CS CE CR CO CU SS GI GR GU H HU J GC LE L LU MA ML OR P PO SA TF SG SE SO T TE TO V VA ZA Z)
fi

# root path project
__root="$(cd "$(dirname "$(dirname "${BASH_SOURCE[0]}")")" && pwd)"

err="${__root}/error.log"
rm --force "${err}"

# handle kill signs
trap "echo; exit 1" INT TERM

for region in "${REGIONS[@]}"
do
  # feature or report must set the query param "region" in order to get the proper results
  if [ $# -gt 0 ]; then
    var="REGION='${region}'"
  else
    var="REGION=''"
  fi

  # prepend the region to the output file
  if [ "${type}" == "feature" ]; then
    echo -ne "Creando GeoJSON para ${region}... \t\t\t"
    output="$(dirname "${file}")/${region}.$(basename "${file}")"
  elif [ "${type}" == "report" ]; then
    echo -ne "Creando informe para ${region}... \t\t\t"
    output="$(dirname "${file}")/${region}.$(basename "${file}")"
  fi

  mkdir --parents "$(dirname "${output}")"

  # run psql with the corresponding variables
  if psql --dbname=osm --single-transaction --variable="ON_ERROR_STOP=1" --variable="${var}" --output="${output}" "${opts[@]}" 2>> "${err}"; then
    echo -ne "[\033[0;32mOK\033[0m]\t\t\t"
  else
    echo -ne "[\033[0;31merror\033[0m]\t\t\t"
  fi

  echo -ne "$(basename "${output}")$(printf '\t')$(wc -c "${output}" | cut -d ' ' -f 1 | numfmt --to=si)\n"
done

# display the errors, if any
if [ -s "${err}" ]; then
  echo
  cat "${err}"
  exit 1
else
  rm --force "${err}"
fi

exit 0;
