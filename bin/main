#!/bin/bash

output=${1:-$(pwd)}

# root path project
__root="$(cd "$(dirname "$(dirname "${BASH_SOURCE[0]}")")" && pwd)"

# mergea los CSV de cada CCAA con sus features de municipios
function generate_reports() {
#  for i in AN AR AS CB CE CL CM CN CT EX GA IB MC MD ML NC PV RI VC; do
# sin ceuta y melilla
  for i in AN AR AS CB CL CM CN CT EX GA IB MC MD NC PV RI VC; do
    ${__root}/bin/merge --reports "$(grep -lnrw ${__root}/reports -e ES-$i)" --feature "${__root}/features/municipios/$i.feature.geojson" --name "$1/$i.topo.json";
    sum_reports $i > ${__root}/$i.agg
  done
  ${__root}/bin/merge --reports "${__root}/*.agg" --feature "${__root}/features/ccaa/ES.feature.geojson" --name "$1/ES.topo.json";
  rm --force ${__root}/*.agg
}

# suma todas las filas que matcheen el parÃ¡metro
function sum_reports() {
  [[ $# -eq 0 ]] && ( echo "Falta argumento"; return 1; )

  local initlang=$(echo $LANG)
  local pattern="ES-$1"

  LANG=en_US.UTF-8;

  echo "id;date;incomplete;total;percentage;length_incomplete;length_total;length_percentage"
  grep --no-filename --recursive --word-regexp ${__root} --regexp ${pattern} | awk -F";" -v group=${pattern} 'FNR>1{ a[$5]+=$6; b[$5]+=$7; c[$5]+=$9; d[$5]+=$10 } END {for (i in a) { print group, i, a[i], b[i], b[i] != 0 ? 1 - (a[i]/b[i]) : 1, c[i], d[i], d[i] != 0 ? 1 - (c[i]/d[i]) : 1 }}' OFS=";" OFMT="%.2f" | sort --key 2 --human-numeric-sort

  LANG=$initlang;
}

# update the databases
if "${__root}/bin/updatedb"; then
  # create a new csv report
  if "${__root}/bin/report" prov; then
    #~ git add "${__root}/reports/$(date +%Y%m)"
    #~ git commit -a -m "reports $(date +%Y%m)"
    #~ git push
    # create the topojson files with all the reports found
    generate_reports ${output}
  else
    echo "Error en report"
    exit 1;
  fi
else
  echo "Error en updatedb"
  exit 1;
fi

exit 0;
