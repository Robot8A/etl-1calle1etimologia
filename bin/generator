#!/bin/bash

output=${1:-$(pwd)}

# root path project
__root="$(cd "$(dirname "$(dirname "${BASH_SOURCE[0]}")")" && pwd)"

# merge reports by CCAA with their features
function generate_reports() {
  for i in AN AR AS CB CE CL CM CN CT EX GA IB MC MD ML NC PV RI VC; do
    "${__root}/bin/merge" --reports "$(grep -lnrw "${__root}/reports" -e ES-"${i}")" --feature "${__root}/features/municipios/${i}.feature.geojson" --name "$1/${i}.topo.json";
    sum_reports "${i}" > "${__root}/${i}.agg"
  done

  "${__root}/bin/merge" --reports "${__root}/*.agg" --feature "${__root}/features/ccaa/ES.feature.geojson" --name "$1/ES.ccaa.topo.json";
  rm --force "${__root}"/*.agg
}

# aggregation reports
function sum_reports() {
  [[ $# -eq 0 ]] && ( echo "Falta argumento"; return 1; )

  local initlang="${LANG}"
  local pattern="ES-$1"

  LANG=en_US.UTF-8;

  echo "id;date;incomplete;total;percentage;length_incomplete;length_total;length_percentage"
  grep --no-filename --recursive --word-regexp "${__root}/reports" --regexp "${pattern}" | awk -F";" -v group="${pattern}" 'FNR>1{ a[$5]+=$6; b[$5]+=$7; c[$5]+=$9; d[$5]+=$10 } END {for (i in a) { print group, i, a[i], b[i], b[i] != 0 ? 1 - (a[i]/b[i]) : 1, c[i], d[i], d[i] != 0 ? 1 - (c[i]/d[i]) : 1 }}' OFS=";" OFMT="%.2f" | sort --key 2 --human-numeric-sort

  LANG="${initlang}";
}

function log() {
  local columns=$(tput cols)
  local text="$1"

  printf '=%.0s' $(seq 1 ${columns})
  printf "%*s\n" $(((${#text}+$columns)/2)) "$text"
  printf '=%.0s' $(seq 1 ${columns})
}

# update the databases
STEP=${STEP:-0}
[ "${STEP}" -gt 0 ] && log "Saltándose el primer paso..." || log "Actualizando la base de datos"

if [ "${STEP}" -gt 0 ] || "${__root}/bin/updatedb"; then

  # create a new csv report
  [ "${STEP}" -gt 1 ] && log "Saltándose el segundo paso..." || log "Generando informes CSV"

  if [ "${STEP}" -gt 1 ] || "${__root}/bin/report" prov; then
    # create the topojson files with all the reports found
    log "Creando ficheros topojson"

    generate_reports "${output}"

    # remove database
    dropdb --username="${PGUSER:-$(whoami)}" "${PGDATABASE:-osm}"
  else
    echo "Error en report"
    exit 1;
  fi
else
  echo "Error en updatedb"
  exit 1;
fi

exit 0;
