name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Build the Docker image
      run: docker build . --file Dockerfile --tag etl-1calle1etimologia
      
    - name: Prepare output directories
      run: mkdir -p reports features

    - name: Generate full report
      env:
        TERM: xterm-256color
      run: docker run --rm --name etl_run --entrypoint /bin/sh etl-1calle1etimologia -c "service postgresql start && bash bin/generator"

    - name: Copy outputs from container
      run: |
        docker cp etl_run:/app/reports ./reports || true
        docker cp etl_run:/app/features ./features || true

    - name: Remove container
      run: docker rm -f etl_run || true

    - name: Upload generated files
      uses: actions/upload-artifact@v4
      with:
        name: etl-reports
        path: |
          reports/
          features/
        retention-days: 30

    - name: Dump container logs
      if: failure()
      run: docker logs etl_run || true
