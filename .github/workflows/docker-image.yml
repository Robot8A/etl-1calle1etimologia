name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Create output directories
      run: mkdir -p reports features

    - name: Build the Docker image
      run: docker build . --file Dockerfile --tag etl-1calle1etimologia
      
    - name: Start ETL container
      run: |
        docker run -d \
          --name etl_run \
          -v $(pwd)/reports:/root/reports \
          -v $(pwd)/features:/root/features \
          -v $(pwd)/output:/root/output \
          --entrypoint /bin/sh \
          etl-1calle1etimologia \
          -c "service postgresql start && mkdir ./output && tail -f /dev/null"

    - name: Download data & setup database (only Arag√≥n)
      run: |
        docker exec -t etl_run sh -c "
          curl --fail --progress-bar --remote-name https://download.geofabrik.de/europe/spain/aragon-$(date +%y%m)01.osm.pbf &&
          bash bin/updatedb *.osm.pbf
        "

    - name: Run full analysis
      run: docker exec -it -e STEP=1 etl_run bin/generator

    - name: Remove container
      if: always()
      run: docker rm -f etl_run || true

    - name: Upload generated files
      uses: actions/upload-artifact@v4
      with:
        name: etl-reports
        path: |
          reports/
          features/
          output/
        retention-days: 30

    - name: Dump container logs
      if: failure()
      run: docker logs etl_run || true
