#!/bin/bash

# get the preset from the wrapper scripts
IFS='|'
read -ra opts <<< "$1"
IFS=' '
file="$2"

shift 2

REGIONS=("${@:-ES}")

if [[ "${1,,}" == "ccaa" ]]; then
  REGIONS=(AN AR AS CB CE CL CM CN CT EX GA IB MC MD ML NC PV RI VC)
elif [[ "${1,,}" == "prov" ]]; then
  REGIONS=(A AB AL AV B BA BI BU C CA CC CE CO CR CS CU GC GI GR GU H HU J L LE LO LU M MA ML MU NA O OR P PM PO S SA SE SG SO SS T TE TF TO V VA VI Z ZA)
fi

# root path project
__root="$(cd "$(dirname "$(dirname "${BASH_SOURCE[0]}")")" && pwd)"

err="${__root}/error.log"
rm --force "${err}"

# handle kill signs
trap "echo; exit 1" INT TERM

for region in "${REGIONS[@]}"
do
  # feature or report must set the query param "region" in order to get the proper results
  if [ $# -gt 0 ]; then
    var="REGION='${region}'"
  else
    var="REGION=''"
  fi

  # prepend the region to the output file
  output="$(dirname "${file}")/${region}.$(basename "${file}")"
  mkdir --parents "$(dirname "${output}")"

  # run psql with the corresponding variables
  if psql --username "${PGUSER:-$(whoami)}" --dbname "${PGDATABASE:-osm}" --single-transaction --variable="ON_ERROR_STOP=1" --variable="${var}" --output="${output}" "${opts[@]}" 2>> "${err}"; then
    if [ $(wc -l ${output} | cut -d ' ' -f 1) -gt 1 ]; then
      echo -ne "[  \033[0;32mOK\033[0m  ]\t"
    else
      echo -ne "[ \033[0;33mwarn\033[0m ]\t"
    fi
  else
    echo -ne "[ \033[0;31merror\033[0m ]\t"
  fi

  echo -ne "${output}$(printf '\t')$(wc -c "${output}" | cut -d ' ' -f 1 | numfmt --to=si | xargs printf '%6s')\n"
done

# display the errors, if any
if [ -s "${err}" ]; then
  echo
  cat "${err}"
  exit 1
else
  rm --force "${err}"
fi

exit 0;
