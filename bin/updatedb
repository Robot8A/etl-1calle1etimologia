#!/bin/bash

# root path project
__root="$(cd "$(dirname "$(dirname "${BASH_SOURCE[0]}")")" && pwd)"
output="${__root}/${1:-full-spain-$(date +%y%m)01.osm.pbf}"

# handle kill signs
trap "echo; exit 1" INT TERM

# if no arguments, download the new dumps, otherwise, load that dump
if [[ -z $1 ]]; then
  # remove previous dumps, if any
  rm --force "${__root}"/*.osm.pbf

  # fetch the dumps
  echo "Descargando spain-$(date +%y%m)01.osm.pbf"
  if ( cd "${__root}" && curl --fail --progress-bar --remote-name "https://download.geofabrik.de/europe/spain-$(date +%y%m)01.osm.pbf" ); then
    echo "Descargando canary-islands-$(date +%y%m)01.osm.pbf"
    if ( cd "${__root}" && curl --fail --progress-bar --remote-name "https://download.geofabrik.de/africa/canary-islands-$(date +%y%m)01.osm.pbf" ); then
      # combine both dumps into a single one
      echo "Combinando ambas descargas en ${output}"
      if ! osmium merge --progress "${__root}"/*.pbf --output "${output}"; then
         exit 1;
      fi
    else
      exit 1;
    fi
  else
    exit 1;
  fi
fi

# create database
createdb --username="${PGUSER:-$(whoami)}" "${PGDATABASE:-osm}"
# create extensions
psql --username="${PGUSER:-$(whoami)}" --dbname="${PGDATABASE:-osm}" --command 'CREATE EXTENSION IF NOT EXISTS postgis;' --quiet
psql --username="${PGUSER:-$(whoami)}" --dbname="${PGDATABASE:-osm}" --command 'CREATE EXTENSION IF NOT EXISTS unaccent;' --quiet

# load the dumps into osm database
osm2pgsql --create --slim --drop --cache=4096 --multi-geometry --proj=4326 --database="${PGDATABASE:-osm}" --user="${PGUSER:-$(whoami)}" --style="${__root}/config/1calle1nombre.style" "${output}"

exit $?;
